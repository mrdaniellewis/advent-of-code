# frozen_string_literal: true

require "json"
require "byebug"

numbers = []

DATA.each_line.map(&:strip).each do |line|
  numbers << JSON.parse(line)
end

def explode(n0)
  found = nil
  left = nil

  n0.each_with_index do |n1, x1|
    if n1.is_a?(Integer)
      if found
        n0[x1] += found[1]
        return true
      end
      next left = [x1]
    end

    n1.each_with_index do |n2, x2|
      if n2.is_a?(Integer)
        if found
          n1[x2] += found[1]
          return true
        end
        next left = [x1, x2]
      end

      n2.each_with_index do |n3, x3|
        if n3.is_a?(Integer)
          if found
            n2[x3] += found[1]
            return true
          end
          next left = [x1, x2, x3]
        end

        n3.each_with_index do |n4, x4|
          if n4.is_a?(Integer)
            if found
              n3[x4] += found[1]
              return true
            end
            next left = [x1, x2, x3, x4]
          end

          if found
            n3[x4][0] += found[1]
            return true
          else
            found = n4
            n3[x4] = 0
            left[0..-2].reduce(n0) { |array, x| array[x] }[left.last] += n4[0] if left
          end
        end
      end
    end
  end

  !!found
end

def split(n)
  n.each_with_index do |n1, x1|
    if n1.is_a?(Integer) && n1 > 9
      n[x1] = [(n1 / 2.0).floor, (n1 / 2.0).ceil]
      return true
    end

    return true if n1.is_a?(Array) && split(n1)
  end

  false
end

def reduce(number)
  loop do
    next if explode(number)
    next if split(number)

    break
  end

  number
end

def magnitude((n1, n2))
  [
    (n1.is_a?(Array) ? magnitude(n1) : n1) * 3,
    (n2.is_a?(Array) ? magnitude(n2) : n2) * 2
  ].sum
end

puts magnitude(numbers.reduce do |last, current|
  reduce([last, current])
end)

__END__
[[0,[[0,9],[6,5]]],[[[5,3],[0,4]],[8,3]]]
[[[[8,6],4],[2,5]],[[[7,4],[4,3]],[[3,4],[3,3]]]]
[[[6,[0,2]],[5,[7,4]]],[1,2]]
[[[[5,4],0],[[5,3],[1,4]]],[[[8,9],[0,0]],1]]
[[[7,0],2],[0,[4,2]]]
[4,[6,2]]
[[[[9,5],[3,4]],[[9,4],[5,3]]],[5,[[0,3],[4,4]]]]
[[[6,0],[3,4]],[9,[[0,3],3]]]
[[[[4,0],5],2],[[4,7],[9,0]]]
[[[2,4],[[3,6],[5,5]]],[[9,[1,1]],[1,1]]]
[[[[8,8],1],8],0]
[[0,6],[[[1,1],8],[[1,7],[6,3]]]]
[[4,8],[[1,[8,4]],[[5,9],[6,3]]]]
[3,[[0,[0,8]],[[2,5],9]]]
[[[[8,8],[5,8]],[[5,2],3]],[[[6,5],2],[6,8]]]
[[[5,[0,8]],[[8,3],[0,4]]],[[[2,5],8],[[0,4],3]]]
[[[7,5],2],[[[3,6],[1,7]],[1,[6,2]]]]
[[[[7,7],1],4],[[8,[5,1]],4]]
[[[[5,0],[9,0]],[[3,3],[1,0]]],[[0,[8,9]],7]]
[[[[4,0],[8,9]],[1,9]],[[[1,7],[9,5]],[[1,4],[9,5]]]]
[[7,0],5]
[[[[3,7],3],[[1,1],[4,9]]],[2,[6,3]]]
[[2,[6,[4,4]]],[0,[0,[6,3]]]]
[[[3,[5,3]],4],[0,4]]
[7,[[[8,8],[6,3]],[9,5]]]
[[7,[4,4]],[5,7]]
[[6,3],[[2,0],[9,6]]]
[[[0,[7,9]],[[5,6],0]],[[4,[8,9]],[8,[3,6]]]]
[[5,[3,[7,0]]],[[4,1],[[1,1],[3,0]]]]
[[9,[2,4]],[[2,[8,1]],[[4,5],1]]]
[[8,[0,[8,2]]],[[2,4],[[2,6],8]]]
[[[[8,1],5],2],[0,[[5,7],8]]]
[[[[9,2],[6,0]],[3,[9,6]]],[[[2,1],0],[[6,2],[2,0]]]]
[[[[6,6],1],[2,3]],[9,[[4,8],5]]]
[[3,[[1,5],[8,4]]],[[6,6],3]]
[[[4,8],5],3]
[[0,[[5,4],[9,7]]],[[[0,5],[7,6]],[[6,9],[1,9]]]]
[[[9,[1,1]],[7,[2,9]]],[[6,[3,6]],[[4,5],[1,0]]]]
[[[5,[7,7]],9],2]
[1,[[0,[3,2]],[1,[8,7]]]]
[5,[[5,[3,5]],[[4,1],[8,3]]]]
[[0,4],[[[2,6],7],3]]
[5,9]
[[[[9,2],[3,9]],3],[0,[[8,4],0]]]
[[[9,7],[6,[3,3]]],3]
[2,[[4,0],[8,[8,4]]]]
[[2,4],[9,[[2,9],4]]]
[[[[9,7],[9,5]],[[9,2],[3,9]]],0]
[2,[0,[[2,2],6]]]
[[[[8,9],[7,9]],[3,[1,4]]],[[1,[9,5]],[[1,9],7]]]
[[[1,[3,6]],0],[9,[8,[2,2]]]]
[[[7,3],[[7,2],[4,3]]],[[9,[7,7]],7]]
[[[3,[6,4]],4],[[[8,9],[6,6]],[1,[9,1]]]]
[[[[6,3],[1,8]],[6,9]],[[[0,0],2],0]]
[[[8,9],7],1]
[[[[3,2],[7,5]],2],9]
[[[[4,9],5],4],[0,[[2,4],[7,8]]]]
[[[[8,1],[6,5]],[[8,1],[9,7]]],9]
[0,[1,6]]
[[[5,9],[[9,8],6]],[0,[5,[1,2]]]]
[9,[[[4,3],5],[9,3]]]
[[[9,[2,7]],[2,[9,0]]],[[1,[8,7]],[[3,5],[2,6]]]]
[9,[[3,8],[[4,5],[7,1]]]]
[[0,[2,8]],[[6,3],5]]
[[[6,[2,5]],[[2,1],8]],[5,[[4,9],[0,3]]]]
[[[[0,4],3],[[1,3],[3,2]]],9]
[9,[[2,8],[[3,8],7]]]
[[[4,[1,9]],[3,3]],[0,[[4,3],[1,7]]]]
[[6,[[5,2],[2,5]]],[1,[[0,0],[1,4]]]]
[9,[1,[7,[5,6]]]]
[[5,4],6]
[6,[[5,6],7]]
[[[3,[6,0]],[8,[3,5]]],[[5,1],[[7,9],3]]]
[[[6,[8,7]],[[5,2],0]],[[6,[4,0]],[1,[1,2]]]]
[3,[[[7,8],0],[[6,5],0]]]
[[4,9],[9,9]]
[[7,[5,[9,7]]],1]
[[[3,[3,3]],[4,6]],[[[9,5],[4,8]],[5,[2,0]]]]
[[[[8,6],6],8],[3,1]]
[6,[5,0]]
[2,[[2,[7,5]],[6,[0,6]]]]
[[[9,[1,3]],[0,[9,4]]],4]
[[[[2,5],[9,9]],[[8,2],2]],[9,[1,[9,1]]]]
[[[[8,9],0],[[2,5],[2,2]]],[[7,[4,1]],[[3,9],[5,8]]]]
[[[7,6],[6,3]],5]
[2,[[[5,8],[1,2]],0]]
[[[8,7],[6,4]],[[[0,6],2],[[2,1],5]]]
[2,1]
[0,[[[4,3],[6,6]],8]]
[4,2]
[[[6,[3,2]],[5,[2,3]]],[[[3,5],[6,2]],[1,[6,6]]]]
[[0,[[8,1],[0,5]]],[[[3,3],3],[[6,8],5]]]
[[[3,0],[4,[6,5]]],[[[3,3],[4,0]],6]]
[[[[7,3],4],4],[[7,[8,2]],0]]
[[[4,3],[0,9]],[[1,[8,9]],[[3,0],0]]]
[[3,2],[2,[[2,6],[2,1]]]]
[2,8]
[[[[1,4],[7,3]],[8,[2,1]]],4]
[[[1,7],[1,[4,8]]],[[[2,2],[6,1]],[[9,9],8]]]
[[[5,[7,2]],[[8,6],6]],[1,5]]
